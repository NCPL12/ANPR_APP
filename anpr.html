<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANPR Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #e8eef4; color: #1e3a5f; min-height: 100vh; }
        .page { max-width: 1200px; margin: 0 auto; padding: 0 24px 24px; }
        /* Header */
        .header { background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%); padding: 14px 0; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(30,58,95,0.25); }
        .header .inner { max-width: 1200px; margin: 0 auto; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
        .header .title { font-size: 1.35rem; font-weight: 700; color: #fff; }
        .header .right { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .header .btn { padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; border: none; text-decoration: none; color: inherit; }
        .header .btn-ghost { background: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.3); }
        .header .btn-ghost:hover { background: rgba(255,255,255,0.3); }
        .header .btn-green { background: #3182ce; color: #fff; }
        .header .btn-green:hover { background: #2b6cb0; }
        .header .user { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #fff; }
        .header .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.25); display: flex; align-items: center; justify-content: center; font-weight: 600; color: #fff; }
        .header .notif { position: relative; padding: 8px; cursor: pointer; }
        .header .notif .badge { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background: #63b3ed; border-radius: 50%; }
        /* Summary cards */
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(30,58,95,0.08); display: flex; align-items: flex-start; justify-content: space-between; border: 1px solid rgba(49,130,206,0.15); }
        .card.green { border-left: 4px solid #3182ce; background: linear-gradient(135deg, #ebf8ff 0%, #fff 100%); }
        .card.orange { border-left: 4px solid #4299e1; background: linear-gradient(135deg, #ebf8ff 0%, #fff 100%); }
        .card.blue { border-left: 4px solid #2b6cb0; background: linear-gradient(135deg, #bee3f8 0%, #fff 100%); }
        .card.red { border-left: 4px solid #2c5282; background: linear-gradient(135deg, #e6fffa 0%, #fff 100%); }
        .card .value { font-size: 1.75rem; font-weight: 700; color: #1e3a5f; margin: 4px 0; }
        .card .label { font-size: 0.9rem; color: #4a5568; }
        .card .change { font-size: 0.8rem; color: #3182ce; margin-top: 4px; }
        .card .icon-wrap { width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .card.green .icon-wrap { background: #bee3f8; }
        .card.orange .icon-wrap { background: #90cdf4; }
        .card.blue .icon-wrap { background: #63b3ed; }
        .card.red .icon-wrap { background: #4299e1; }
        /* Table section */
        .table-section { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(30,58,95,0.08); padding: 20px; margin-bottom: 24px; border: 1px solid rgba(49,130,206,0.12); }
        .table-header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
        .table-title { font-size: 1rem; font-weight: 600; color: #1e3a5f; }
        .table-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .table-controls select { padding: 6px 10px; border: 1px solid #bee3f8; border-radius: 6px; font-size: 0.875rem; background: #fff; color: #1e3a5f; }
        .table-controls .view-toggle { display: flex; border: 1px solid #bee3f8; border-radius: 6px; overflow: hidden; }
        .table-controls .view-toggle button { padding: 6px 12px; border: none; background: #fff; cursor: pointer; font-size: 0.875rem; color: #1e3a5f; }
        .table-controls .view-toggle button.active { background: #ebf8ff; color: #2b6cb0; font-weight: 500; }
        .btn-export { padding: 8px 16px; background: #3182ce; color: #fff; border: none; border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 500; }
        .btn-export:hover { background: #2b6cb0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #ebf8ff; color: #1e3a5f; font-weight: 600; }
        th.sortable { cursor: pointer; user-select: none; white-space: nowrap; }
        th.sortable:hover { color: #2b6cb0; }
        th .sort-arrow { margin-left: 4px; opacity: 0.5; font-size: 0.75em; }
        th.sort-asc .sort-arrow, th.sort-desc .sort-arrow { opacity: 1; color: #2b6cb0; }
        tr:hover { background: #ebf8ff; }
        .plate-img { width: 80px; height: 44px; background: #ebf8ff; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #2b6cb0; font-size: 0.75rem; }
        .search-common { margin-bottom: 12px; }
        .search-common input { width: 100%; max-width: 400px; padding: 8px 12px; border: 1px solid #bee3f8; border-radius: 6px; font-size: 0.9rem; }
        .search-common input::placeholder { color: #718096; }
        .filter-row th { padding: 6px 8px; vertical-align: middle; }
        .filter-row input { width: 100%; min-width: 0; padding: 6px 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.8rem; }
        .export-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-top: 16px; padding: 12px 0; border-top: 1px solid #e2e8f0; }
        .export-bar label { font-size: 0.875rem; color: #4a5568; }
        .export-bar input[type="datetime-local"] { padding: 6px 10px; border: 1px solid #bee3f8; border-radius: 6px; font-size: 0.875rem; }
        .btn-export-excel { padding: 8px 16px; background: #2f855a; color: #fff; border: none; border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 500; }
        .btn-export-excel:hover { background: #276749; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(30,58,95,0.4); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: #fff; border-radius: 12px; padding: 24px; min-width: 320px; max-width: 90vw; box-shadow: 0 8px 32px rgba(30,58,95,0.2); border: 1px solid rgba(49,130,206,0.2); }
        .modal-box h2 { margin: 0 0 20px; font-size: 1.15rem; color: #1e3a5f; }
        .modal-box .field { margin-bottom: 16px; }
        .modal-box .field label { display: block; font-size: 0.875rem; color: #4a5568; margin-bottom: 6px; }
        .modal-box .field input[type="datetime-local"] { width: 100%; padding: 8px 12px; border: 1px solid #bee3f8; border-radius: 6px; font-size: 0.9rem; }
        .modal-box .actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
        .modal-box .btn-cancel { padding: 8px 16px; background: #e2e8f0; color: #1e3a5f; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; }
        .modal-box .btn-cancel:hover { background: #cbd5e0; }
        /* QR section */
        .qr-section { display: flex; align-items: center; gap: 20px; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(30,58,95,0.08); max-width: 380px; border: 1px solid rgba(49,130,206,0.12); }
        .qr-section .qr { width: 120px; height: 120px; background: #ebf8ff; border: 1px solid #bee3f8; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #2b6cb0; flex-shrink: 0; }
        .qr-section .qr-text { font-size: 0.9rem; color: #1e3a5f; }
    </style>
</head>
<body>
    <header class="header">
        <div class="inner">
            <h1 class="title">ANPR Dashboard</h1>
            <div class="right">
                <button type="button" class="btn btn-ghost" id="header-export-btn">Export</button>
            </div>
        </div>
    </header>
    <div class="modal-overlay" id="export-modal" aria-hidden="true">
        <div class="modal-box">
            <h2>Export to Excel</h2>
            <div class="field">
                <label for="export-from">From (date & time)</label>
                <input type="datetime-local" id="export-from" />
            </div>
            <div class="field">
                <label for="export-to">To (date & time)</label>
                <input type="datetime-local" id="export-to" />
            </div>
            <div class="actions">
                <button type="button" class="btn-cancel" id="export-modal-cancel">Cancel</button>
                <button type="button" class="btn-export-excel" id="btn-export-excel">Export to Excel</button>
            </div>
        </div>
    </div>
    <div class="page">
        <!-- <section class="cards">
            <div class="card green">
                <div>
                    <div class="label">ANPR Cameras</div>
                    <div class="value" id="stat-cameras">23</div>
                   
                </div>
                <div class="icon-wrap">üì∑</div>
            </div>
            <div class="card orange">
                <div>
                    <div class="label">Total plates today</div>
                    <div class="value" id="stat-today">56</div>
   
                </div>
                <div class="icon-wrap">üöó</div>
            </div>
            <div class="card blue">
                <div>
                    <div class="label">Total plates this week</div>
                    <div class="value" id="stat-week">500</div>
                </div>
                <div class="icon-wrap">üìä</div>
            </div>
            <div class="card red">
                <div>
                    <div class="label">Sites</div>
                    <div class="value" id="stat-sites">2</div>
                </div>
                <div class="icon-wrap">üè¢</div>
            </div>
        </section> -->
        <section class="table-section">
            <div class="table-header">
                <span class="table-title" id="record-count">0 records</span>
            </div>
            <div class="search-common">
                <input type="text" id="search-all" placeholder="Search across all fields‚Ä¶" autocomplete="off" />
            </div>
            <div style="overflow: auto; max-height: 70vh;">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="sno" title="Sort by S.no">S.no <span class="sort-arrow"></span></th>
                            <th class="sortable" data-sort="plate_number" title="Sort by Plate No.">Plate No. <span class="sort-arrow"></span></th>
                            <th class="sortable" data-sort="plate_type" title="Sort by Plate type">Plate type <span class="sort-arrow"></span></th>
                            <th class="sortable" data-sort="date" title="Sort by Date (latest first by default)">Date <span class="sort-arrow"></span></th>
                            <th class="sortable" data-sort="timestamp" title="Sort by Time">Time stamp <span class="sort-arrow"></span></th>
                            <th>Image</th>
                        </tr>
                        <tr class="filter-row">
                            <th><input type="text" id="filter-sno" placeholder="S.no" /></th>
                            <th><input type="text" id="filter-plate_number" placeholder="Plate No." /></th>
                            <th><input type="text" id="filter-plate_type" placeholder="Plate type" /></th>
                            <th><input type="text" id="filter-date" placeholder="Date" /></th>
                            <th><input type="text" id="filter-timestamp" placeholder="Time" /></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="6" style="text-align:center;padding:24px;">Loading‚Ä¶</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="pagination-wrap" class="pagination-wrap" style="display:flex;align-items:center;margin-top:12px;">
                <span id="pagination-info" class="pagination-info" style="font-size:0.875rem;color:#4a5568;"></span>
            </div>
        </section>
    </div>
    <script>
        var API = window.location.origin;

        function formatDate(iso) {
            if (!iso) return '‚Äî';
            var d = new Date(iso);
            if (isNaN(d.getTime())) return '‚Äî';
            var day = ('0' + d.getUTCDate()).slice(-2);
            var month = d.getUTCMonth() + 1;
            var year = ('' + d.getUTCFullYear()).slice(-2);
            return day + '.' + month + '.' + year;
        }
        function formatTime(iso) {
            if (!iso) return '‚Äî';
            var d = new Date(iso);
            if (isNaN(d.getTime())) return '‚Äî';
            return ('0' + d.getUTCHours()).slice(-2) + ':' + ('0' + d.getUTCMinutes()).slice(-2) + ':' + ('0' + d.getUTCSeconds()).slice(-2);
        }
        function loadStats() {
            fetch(API + '/api/stats')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    document.getElementById('stat-cameras').textContent = data.cameras || '‚Äî';
                    document.getElementById('stat-today').textContent = data.today != null ? data.today : '‚Äî';
                    document.getElementById('stat-week').textContent = data.week != null ? data.week : '‚Äî';
                    document.getElementById('stat-sites').textContent = data.sites || '‚Äî';
                })
                .catch(function() {
                    document.getElementById('stat-cameras').textContent = '‚Äî';
                    document.getElementById('stat-today').textContent = '‚Äî';
                    document.getElementById('stat-week').textContent = '‚Äî';
                    document.getElementById('stat-sites').textContent = '‚Äî';
                });
        }

        var allData = [];
        var sortKey = 'date';
        var sortDir = 'desc';
        var imageCache = new Map();

        function getCommonSearchVal() { return (document.getElementById('search-all') && document.getElementById('search-all').value) || ''; }
        function getColumnFilter(col) {
            var el = document.getElementById('filter-' + col);
            return (el && el.value) || '';
        }
        function rowToSearchText(row) {
            var date = formatDate(row.timestamp || row.created_at);
            var time = formatTime(row.timestamp || row.created_at);
            return [ (row.plate_number || ''), (row.plate_type || ''), date, time ].join(' ');
        }
        function getFilteredData(optFrom, optTo) {
            var list = allData;
            var common = getCommonSearchVal().trim().toLowerCase();
            if (common) {
                list = list.filter(function(row) { return rowToSearchText(row).toLowerCase().indexOf(common) !== -1; });
            }
            var fPlate = getColumnFilter('plate_number').trim().toLowerCase();
            var fType = getColumnFilter('plate_type').trim().toLowerCase();
            var fDate = getColumnFilter('date').trim().toLowerCase();
            var fTime = getColumnFilter('timestamp').trim().toLowerCase();
            if (fPlate) list = list.filter(function(row) { return (row.plate_number || '').toLowerCase().indexOf(fPlate) !== -1; });
            if (fType) list = list.filter(function(row) { return (row.plate_type || '').toLowerCase().indexOf(fType) !== -1; });
            if (fDate) list = list.filter(function(row) { return formatDate(row.timestamp || row.created_at).toLowerCase().indexOf(fDate) !== -1; });
            if (fTime) list = list.filter(function(row) { return formatTime(row.timestamp || row.created_at).toLowerCase().indexOf(fTime) !== -1; });
            if (optFrom != null || optTo != null) {
                list = list.filter(function(row) {
                    var t = row.timestamp || row.created_at;
                    if (!t) return false;
                    var ms = new Date(t).getTime();
                    if (optFrom != null && ms < optFrom) return false;
                    if (optTo != null && ms > optTo) return false;
                    return true;
                });
            }
            return list;
        }

        function getSortValue(row, key) {
            if (key === 'date' || key === 'timestamp') {
                var t = row.timestamp || row.created_at;
                return t ? new Date(t).getTime() : 0;
            }
            if (key === 'plate_number') return (row.plate_number || '').toLowerCase();
            if (key === 'plate_type') return (row.plate_type || '').toLowerCase();
            if (key === 'sno') return 0;
            return 0;
        }

        function sortData(data) {
            var key = sortKey;
            var dir = sortDir === 'asc' ? 1 : -1;
            return data.slice().sort(function(a, b) {
                var va = getSortValue(a, key);
                var vb = getSortValue(b, key);
                if (key === 'plate_number' || key === 'plate_type') {
                    return dir * (va.localeCompare(vb));
                }
                return dir * (va - vb);
            });
        }

        function updateArrowHeaders() {
            document.querySelectorAll('th.sortable').forEach(function(th) {
                th.classList.remove('sort-asc', 'sort-desc');
                var arrow = th.querySelector('.sort-arrow');
                if (arrow && th.getAttribute('data-sort') === sortKey) {
                    th.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
                    arrow.textContent = sortDir === 'asc' ? '‚Üë' : '‚Üì';
                } else if (arrow) {
                    arrow.textContent = '‚Üï';
                }
            });
        }

        function renderTable() {
            var tbody = document.getElementById('table-body');
            if (allData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;">No records</td></tr>';
                document.getElementById('record-count').textContent = '0 records';
                updatePagination(0);
                return;
            }
            var filtered = getFilteredData();
            var sorted = sortData(filtered);
            var fSno = getColumnFilter('sno').trim().toLowerCase();
            if (fSno) sorted = sorted.filter(function(row, i) { return ('' + (i + 1)).toLowerCase().indexOf(fSno) !== -1; });
            tbody.innerHTML = sorted.map(function(row, i) {
                var date = formatDate(row.timestamp || row.created_at);
                var time = formatTime(row.timestamp || row.created_at);
                var imgHtml = row.image_saved
                    ? '<img data-src="' + API + '/api/plates/' + row.id + '/image/img" data-plate-id="' + (row.id || '') + '" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Plate" class="plate-img lazy-plate-img" style="width:80px;height:44px;object-fit:contain;border-radius:6px;" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';"><div class="plate-img plate-img-placeholder" style="display:none;">Plate</div>'
                    : '<div class="plate-img">‚Äî</div>';
                return '<tr><td>' + (i + 1) + '</td><td>' + (row.plate_number || '‚Äî') + '</td><td>' + (row.plate_type || '‚Äî') + '</td><td>' + date + '</td><td>' + time + '</td><td>' + imgHtml + '</td></tr>';
            }).join('');
            var total = allData.length;
            var shown = sorted.length;
            document.getElementById('record-count').textContent = total === shown ? total.toLocaleString() + ' records' : shown.toLocaleString() + ' of ' + total.toLocaleString() + ' records';
            updatePagination(shown);
            setupLazyPlateImages();
        }

        function setupLazyPlateImages() {
            var tbody = document.getElementById('table-body');
            var imgs = tbody.querySelectorAll('img.lazy-plate-img[data-src]');
            if (!imgs.length) return;
            var tableWrap = tbody.closest('table').parentElement;
            var observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (!entry.isIntersecting) return;
                    var img = entry.target;
                    var id = img.getAttribute('data-plate-id');
                    var url = img.getAttribute('data-src');
                    observer.unobserve(img);
                    if (!url) return;
                    if (imageCache.has(id)) {
                        img.src = imageCache.get(id);
                        return;
                    }
                    fetch(url).then(function(r) { return r.blob(); }).then(function(blob) {
                        var objectUrl = URL.createObjectURL(blob);
                        imageCache.set(id, objectUrl);
                        img.src = objectUrl;
                    }).catch(function() {
                        img.style.display = 'none';
                        if (img.nextElementSibling) img.nextElementSibling.style.display = 'flex';
                    });
                });
            }, { root: tableWrap, rootMargin: '100px', threshold: 0.01 });
            imgs.forEach(function(img) { observer.observe(img); });
        }

        function loadPlates() {
            var url = API + '/api/plates?limit=all&page=1&sort=date-desc';
            document.getElementById('table-body').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;">Loading‚Ä¶</td></tr>';
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    allData = data.items || [];
                    sortKey = 'date';
                    sortDir = 'desc';
                    updateArrowHeaders();
                    renderTable();
                })
                .catch(function() {
                    document.getElementById('table-body').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;">Error loading data.</td></tr>';
                    updatePagination(0);
                });
        }

        function updatePagination(shown) {
            document.getElementById('pagination-info').textContent = 'Showing all ' + (shown || 0).toLocaleString() + ' records';
        }

        function escapeCsv(val) {
            var s = (val == null ? '' : val).toString();
            if (s.indexOf(',') !== -1 || s.indexOf('"') !== -1 || s.indexOf('\n') !== -1) return '"' + s.replace(/"/g, '""') + '"';
            return s;
        }
        function openExportModal() {
            document.getElementById('export-modal').classList.add('show');
            document.getElementById('export-modal').setAttribute('aria-hidden', 'false');
        }
        function closeExportModal() {
            document.getElementById('export-modal').classList.remove('show');
            document.getElementById('export-modal').setAttribute('aria-hidden', 'true');
        }
        function exportToExcel() {
            var fromEl = document.getElementById('export-from');
            var toEl = document.getElementById('export-to');
            var fromVal = fromEl && fromEl.value ? fromEl.value.trim() : '';
            var toVal = toEl && toEl.value ? toEl.value.trim() : '';
            var fromIso = fromVal ? new Date(fromVal).toISOString() : '';
            var toIso = toVal ? new Date(toVal).toISOString() : '';
            var btn = document.getElementById('btn-export-excel');
            var origText = btn.textContent;
            btn.textContent = 'Exporting‚Ä¶';
            btn.disabled = true;
            var params = new URLSearchParams();
            if (fromIso) params.set('from', fromIso);
            if (toIso) params.set('to', toIso);
            fetch(API + '/api/export/excel?' + params.toString())
                .then(function(r) {
                    if (!r.ok) throw new Error('Export failed');
                    return r.blob();
                })
                .then(function(blob) {
                    var a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    var fromLabel = fromVal ? fromVal.slice(0, 10) : 'all';
                    var toLabel = toVal ? toVal.slice(0, 10) : 'all';
                    a.download = 'anpr_export_' + fromLabel + '_to_' + toLabel + '.xlsx';
                    a.click();
                    URL.revokeObjectURL(a.href);
                    closeExportModal();
                })
                .catch(function() {
                    alert('Export failed. Please try again.');
                })
                .finally(function() {
                    btn.textContent = origText;
                    btn.disabled = false;
                });
        }

        document.getElementById('header-export-btn').addEventListener('click', openExportModal);
        document.getElementById('export-modal').addEventListener('click', function(e) {
            if (e.target === document.getElementById('export-modal')) closeExportModal();
        });
        document.getElementById('export-modal-cancel').addEventListener('click', closeExportModal);
        document.getElementById('search-all').addEventListener('input', renderTable);
        document.getElementById('filter-sno').addEventListener('input', renderTable);
        document.getElementById('filter-plate_number').addEventListener('input', renderTable);
        document.getElementById('filter-plate_type').addEventListener('input', renderTable);
        document.getElementById('filter-date').addEventListener('input', renderTable);
        document.getElementById('filter-timestamp').addEventListener('input', renderTable);
        document.getElementById('btn-export-excel').addEventListener('click', exportToExcel);

        document.querySelectorAll('th.sortable').forEach(function(th) {
            th.addEventListener('click', function() {
                var key = this.getAttribute('data-sort');
                if (!key) return;
                if (sortKey === key) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
                else { sortKey = key; sortDir = key === 'date' || key === 'timestamp' ? 'desc' : 'asc'; }
                updateArrowHeaders();
                renderTable();
            });
        });

        window.addEventListener('beforeunload', function() {
            imageCache.forEach(function(url) { URL.revokeObjectURL(url); });
            imageCache.clear();
        });

        loadStats();
        loadPlates();
    </script>
</body>
</html>
